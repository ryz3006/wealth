<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- SEO Meta Tags -->
    <title>Amigos - Personal Finance Planner App</title>
    <meta name="description" content="A free, all-in-one financial planner to track your net worth, analyze loans with an EMI calculator, manage your 50-30-20 budget, and plan for retirement. Now with Google Drive sync.">
    <meta name="keywords" content="financial planner, wealth planner, loan calculator, emi calculator, net worth tracker, budget tool, 50-30-20 rule, retirement planning, investment simulator, home loan affordability, personal finance dashboard, financial health score, google drive sync, amigos finance">
    <meta name="author" content="Amigos - Personal Finance Planner App">
    <link rel="canonical" href="https://ryz3006.github.io/wealth/">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://ryz3006.github.io/wealth/">
    <meta property="og:title" content="Amigos - Personal Finance Planner App">
    <meta property="og:description" content="A free, all-in-one financial planner to track your net worth, analyze loans, manage your budget, and plan for retirement.">
    <meta property="og:image" content="https://placehold.co/1200x630/e0e7ff/3730a3?text=Amigos+Finance+Planner">

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://ryz3006.github.io/wealth/">
    <meta property="twitter:title" content="Amigos - Personal Finance Planner App">
    <meta property="twitter:description" content="A free, all-in-one financial planner to track your net worth, analyze loans, manage your budget, and plan for retirement.">
    <meta property="twitter:image" content="https://placehold.co/1200x630/e0e7ff/3730a3?text=Amigos+Finance+Planner">

    <!-- Schema.org Markup for Google -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebApplication",
      "name": "Amigos - Personal Finance Planner App",
      "description": "An all-in-one financial planning tool with an EMI calculator, budget manager, net worth tracker, and retirement planner.",
      "applicationCategory": "FinanceApplication",
      "operatingSystem": "All",
      "offers": {
        "@type": "Offer",
        "price": "0",
        "priceCurrency": "USD"
      }
    }
    </script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- PDF Generation Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- Firebase Libraries -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            padding-top: 64px; /* Added padding to prevent content from being hidden behind the fixed top bar */
        }
        .card {
            background-color: white;
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            margin-bottom: 1.5rem;
        }
        .input-group { margin-bottom: 1rem; }
        .input-group label { display: block; color: #4b5563; font-weight: 500; margin-bottom: 0.5rem; font-size: 0.875rem; }
        .input-group input, .input-group select { width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.5rem; transition: border-color 0.2s, box-shadow 0.2s; }
        .input-group input:focus, .input-group select:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.4); }
        .btn { padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: 600; cursor: pointer; transition: all 0.2s; border: none; text-align: center; }
        .btn-primary { background-color: #3b82f6; color: white; }
        .btn-primary:hover:not(:disabled) { background-color: #2563eb; }
        .btn-secondary { background-color: #6b7280; color: white; }
        .btn-secondary:hover { background-color: #4b5563; }
        .btn:disabled { background-color: #9ca3af; cursor: not-allowed; }
        .btn-danger { background-color: #ef4444; color: white; }
        .btn-danger:hover { background-color: #dc2626; }
        .nav-tab { cursor: pointer; padding: 0.5rem 1rem; border-radius: 0.5rem 0.5rem 0 0; font-weight: 500; color: #4b5563; border: 1px solid transparent; border-bottom: none; }
        .nav-tab.active { background-color: white; color: #3b82f6; border-color: #d1d5db; }
        .no-data-overlay { display: none; }
        .no-data-overlay.active { display: flex; }
        .pdf-section-header { font-size: 1.25rem; font-weight: 700; color: #1f2937; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 2px solid #e5e7eb;}
        .suggestion-card { background-color: #eff6ff; border-left: 4px solid #3b82f6; padding: 1rem; margin-bottom: 1rem; border-radius: 0.5rem; }
        .vitals-card { background-color: #f9fafb; padding: 1rem; border-radius: 0.5rem; text-align: center; }
        .vitals-card .label { font-size: 0.875rem; color: #6b7280; }
        .vitals-card .value { font-size: 1.25rem; font-weight: 700; }
        .calc-result { padding: 1rem; background-color: #eef2ff; border-radius: 0.5rem; text-align: center; margin-top: 1rem;}
        .calc-result .label { font-size: 1rem; color: #4338ca; }
        .calc-result .value { font-size: 2rem; font-weight: 700; color: #312e81; }
        .helper-icon { cursor: pointer; color: #9ca3af; margin-left: 0.5rem; display: inline-flex; font-weight: bold; }
        .helper-icon:hover { color: #3b82f6; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0,0,0,0.5); z-index: 100; display: flex; align-items: center; justify-content: center; }
        .modal-content { background-color: white; padding: 2rem; border-radius: 0.75rem; max-width: 500px; width: 90%; }
    </style>
</head>
<body class="p-4 sm:p-6 lg:p-8">

    <div id="top-bar" class="fixed top-0 left-0 right-0 bg-white shadow-md p-2 z-50">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <a href="#" class="flex items-center space-x-2">
                <span class="text-3xl font-bold text-blue-600">â‚¹</span>
                <span class="text-xl font-bold text-gray-800 hidden sm:inline">Amigos - Finance Planner</span>
            </a>
            <div id="auth-container">
                <button id="loginBtn" class="btn btn-primary text-sm py-2 px-3">Login with Google</button>
                <div id="user-info" class="hidden items-center space-x-3">
                    <span id="userName" class="text-sm font-medium text-gray-700"></span>
                    <button id="deleteDataBtn" class="btn btn-danger text-sm py-2 px-3">Delete Data</button>
                    <button id="logoutBtn" class="btn btn-secondary text-sm py-2 px-3">Logout</button>
                </div>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto">
        <header class="my-8 text-center">
             <h1 class="text-4xl font-bold text-gray-800">Comprehensive Wealth Planner</h1>
            <p class="text-lg text-gray-600 mt-2">Your all-in-one dashboard for financial health, analysis, and growth.</p>
        </header>

        <!-- Navigation -->
        <div class="flex flex-wrap space-x-2 border-b">
            <button class="nav-tab active" onclick="showTab('dashboard')">Dashboard</button>
            <button class="nav-tab" onclick="showTab('inputs')">Financial Inputs</button>
            <button class="nav-tab" onclick="showTab('loans')">Loan Planner</button>
            <button class="nav-tab" onclick="showTab('calculators')">Calculators</button>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboardTab" class="card rounded-t-none">
             <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-gray-700">Financial Health Dashboard</h2>
                <div class="flex space-x-2">
                    <button id="loadDataBtn" class="btn btn-secondary hidden">Load Data</button>
                    <button id="saveDataBtn" class="btn btn-secondary hidden">Save Data</button>
                    <button id="refreshDashboardBtn" class="btn btn-secondary">Refresh</button>
                    <button id="downloadPdfBtn" class="btn btn-primary">Download Wealth Report</button>
                </div>
            </div>
            <div id="dashboardReport" class="relative">
                <div id="report-section-inputs" class="hidden"></div>
                <div id="dashboardContent">
                    <div id="report-section-summary" class="grid grid-cols-1 lg:grid-cols-4 gap-6">
                        <div class="lg:col-span-1 flex flex-col items-center justify-center p-4 rounded-lg bg-gray-50"><h3 class="pdf-section-header w-full text-center">Financial Health Score <span class="helper-icon" data-help="score">?</span></h3><div id="financialScoreGauge"></div></div>
                        <div class="lg:col-span-2 p-4 rounded-lg bg-gray-50"><h3 class="pdf-section-header text-center">50-30-20 Budget Rule <span class="helper-icon" data-help="budget">?</span></h3><div class="h-64"><canvas id="budgetChart"></canvas></div></div>
                        <div class="lg:col-span-1 flex flex-col items-center justify-center p-4 rounded-lg bg-gray-50"><h3 class="pdf-section-header w-full text-center">Debt-to-Income Ratio</h3><div id="dtiRatioGauge" class="text-4xl font-bold">0%</div></div>
                    </div>
                    <div id="report-section-budget-explanation" class="mt-8"><h3 class="pdf-section-header">Understanding Your 50-30-20 Budget</h3><div id="budgetRuleExplanation" class="text-sm text-gray-700 mt-2 p-4 bg-gray-50 rounded-lg"></div></div>
                    <div id="report-section-vitals" class="mt-8"><h3 class="pdf-section-header">Cash Flow Summary</h3><div id="financialVitalsContainer" class="grid grid-cols-2 lg:grid-cols-4 gap-4"></div></div>
                    <div id="report-section-suggestions" class="mt-8"><h3 class="pdf-section-header">Suggestions for Improvement</h3><div id="suggestionsContainer"></div></div>
                    <div id="report-section-wealth" class="mt-8"><h3 class="pdf-section-header text-center">Projected Net Worth (10 Yrs)</h3><div class="p-4 rounded-lg bg-gray-50 h-96"><canvas id="wealthGrowthChart"></canvas></div><div id="wealthGrowthExplanation" class="text-sm text-gray-600 mt-2 p-4 bg-gray-50 rounded-lg"></div></div>
                    <div id="report-section-retirement" class="mt-6"><h3 class="pdf-section-header">Retirement Planner <span class="helper-icon" data-help="retirement">?</span></h3><div id="retirementPlanner" class="space-y-4"></div></div>
                    <div id="report-section-goals" class="mt-6"><h3 class="pdf-section-header">Financial Goals Planner <span class="helper-icon" data-help="goals">?</span></h3><div id="goalPlanner" class="space-y-4"></div></div>
                </div>
                <div id="noDataOverlay" class="no-data-overlay absolute inset-0 bg-white/80 backdrop-blur-sm items-center justify-center text-center">
                    <div><h3 class="text-2xl font-bold text-gray-700">No Data Available</h3><p class="text-gray-600 mt-2">Go to 'Financial Inputs' and add your income to generate the dashboard.</p></div>
                </div>
            </div>
        </div>
        
        <!-- Inputs Tab -->
        <div id="inputsTab" class="hidden"><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 pt-4"><div class="card"><h3 class="text-xl font-bold text-gray-700 mb-4">Profile & Income <span class="helper-icon" data-help="income">?</span></h3><div class="input-group"><label for="currentAge">Your Current Age</label><input type="number" id="currentAge" placeholder="e.g., 30"></div><form id="incomeForm"><div class="flex items-end space-x-2"><div class="flex-grow"><label>Income Source</label><select class="income-category-select w-full"><option value="Salary">Salary</option><option value="Rent">Rent</option><option value="Dividend">Dividend</option><option value="Pension">Pension/Returns</option><option value="Other">Other</option></select><input type="text" class="custom-income-category-input hidden w-full mt-2" placeholder="Custom Source"></div><div class="flex-grow"><label>Monthly Amount</label><input type="number" class="income-amount-input w-full" placeholder="50000" required></div><button type="submit" class="btn btn-primary h-10">Add</button></div></form><div id="incomeList" class="mt-4 space-y-2"></div></div><div class="card"><h3 class="text-xl font-bold text-gray-700 mb-4">Assets & Investments <span class="helper-icon" data-help="assets">?</span></h3><form id="assetForm"><div class="input-group"><label for="assetName">Asset/Investment Name</label><input type="text" id="assetName" placeholder="e.g., Mutual Fund SIP" required></div><div class="input-group"><label for="assetType">Type</label><select id="assetType" class="asset-category-select"><option value="stocks">Stocks/ETF</option><option value="mf">Mutual Funds</option><option value="epf">EPF/NPS</option><option value="chits">Chits</option><option value="bank">Bank Balance</option><option value="property">Real Estate</option><option value="Other">Other</option></select><input type="text" id="customAssetCategory" class="custom-asset-category-input hidden w-full mt-2" placeholder="Custom Type"></div><div class="input-group"><label for="assetValue">Current Value</label><input type="number" id="assetValue" placeholder="100000" required></div><div class="grid grid-cols-2 gap-4"><div class="input-group"><label for="monthlySip">Monthly SIP (Optional)</label><input type="number" id="monthlySip" placeholder="5000"></div><div class="input-group"><label for="assetReturn">Exp. Return (%/yr)</label><input type="number" id="assetReturn" placeholder="12" value="0"></div></div><button type="submit" class="btn btn-primary w-full">Add Asset</button></form><div id="assetList" class="mt-4 space-y-2"></div></div><div class="card"><h3 class="text-xl font-bold text-gray-700 mb-4">Expenses, Goals & Insurance <span class="helper-icon" data-help="expenses">?</span></h3><h4 class="font-semibold mb-2">Discretionary Spends (Wants)</h4><form id="wantsForm"><div class="flex items-end space-x-2"><div class="flex-grow"><label>Category</label><select class="wants-category-select w-full"><option value="Shopping">Shopping</option><option value="Dining Out">Dining Out</option><option value="Entertainment">Entertainment</option><option value="Travel">Travel</option><option value="Other">Other</option></select><input type="text" class="custom-wants-category-input hidden w-full mt-2" placeholder="Custom Category"></div><div class="flex-grow"><label>Monthly Amount</label><input type="number" class="wants-amount-input w-full" placeholder="5000" required></div><button type="submit" class="btn btn-primary h-10">Add</button></div></form><div id="wantsList" class="mt-4 space-y-2"></div><hr class="my-6"><h3 class="text-lg font-bold text-gray-700 mb-2">Financial Goals</h3><form id="goalForm"><div class="input-group"><label for="goalName">Dream / Goal</label><input type="text" id="goalName" placeholder="e.g., House Downpayment" required></div><div class="grid grid-cols-2 gap-4"><div class="input-group"><label for="goalAmount">Target Amount</label><input type="number" id="goalAmount" placeholder="500000" required></div><div class="input-group"><label for="goalYears">Target (Years)</label><input type="number" id="goalYears" placeholder="5" required></div></div><button type="submit" class="btn btn-primary w-full">Add Goal</button></form><div id="goalList" class="mt-4 space-y-2"></div><hr class="my-6"><h3 class="text-lg font-bold text-gray-700 mb-2">Insurance</h3><form id="insuranceForm"><div class="input-group"><label for="insuranceType">Policy Type</label><select id="insuranceType"><option value="Term">Term Insurance</option><option value="Life">Life Insurance (Endowment/ULIP)</option><option value="Health">Health Insurance</option></select></div><div class="input-group"><label for="insuranceCover">Cover Amount</label><input type="number" id="insuranceCover" placeholder="10000000" required></div><div class="grid grid-cols-2 gap-4"><div class="input-group"><label for="premiumAmount">Premium Amount</label><input type="number" id="premiumAmount" placeholder="1500" required></div><div class="input-group"><label for="premiumFrequency">Frequency</label><select id="premiumFrequency"><option value="monthly">Monthly</option><option value="yearly">Yearly</option></select></div></div><button type="submit" class="btn btn-primary w-full">Add Insurance</button></form><div id="insuranceList" class="mt-4 space-y-2"></div></div><div class="col-span-full"><button id="downloadInputsBtn" class="btn btn-primary w-full">Download All Inputs as Excel</button></div></div></div>
        
        <!-- Loans Tab -->
        <div id="loansTab" class="hidden pt-4"><div class="grid grid-cols-1 lg:grid-cols-5 gap-8"><div class="lg:col-span-2"><div class="card"><h2 class="text-xl font-bold text-gray-700 mb-4">Add a New Loan <span class="helper-icon" data-help="loans">?</span></h2><form id="loanForm"><div class="input-group"><label for="loanName">Loan Name</label><input type="text" id="loanName" placeholder="e.g., Home Loan" required></div><div class="input-group"><label for="principalLeft">Principal Left (<span id="principalLeftDisplay"></span>)</label><div class="flex items-center space-x-2"><input type="number" id="principalLeft" class="w-2/5" required><input type="range" id="principalLeftSlider" class="w-3/5" min="1000" max="50000000" step="1000"></div></div><div class="input-group"><label for="interestRate">Interest Rate (%) (<span id="interestRateDisplay"></span>)</label><div class="flex items-center space-x-2"><input type="number" step="0.01" id="interestRate" class="w-2/5" required><input type="range" id="interestRateSlider" class="w-3/5" min="1" max="25" step="0.01"></div></div><div class="input-group"><label for="currentEMI">Contractual EMI (<span id="currentEMIDisplay"></span>)</label><div class="flex items-center space-x-2"><input type="number" id="currentEMI" class="w-2/5" required><input type="range" id="currentEMISlider" class="w-3/5" min="100" max="200000" step="100"></div></div><div class="input-group"><label for="emisLeft">EMIs Left (<span id="emisLeftDisplay"></span>)</label><div class="flex items-center space-x-2"><input type="number" id="emisLeft" class="w-2/5" required><input type="range" id="emisLeftSlider" class="w-3/5" min="1" max="360" step="1"></div></div><button type="submit" class="btn btn-primary w-full">Add Loan</button></form></div></div><div class="lg:col-span-3"><div class="card"><h2 class="text-xl font-bold text-gray-700 mb-4">Your Loan Portfolio</h2><div id="loanList" class="space-y-3"></div></div></div></div><div id="detailedAnalysisSection" class="card hidden"><div id="loanReportContent"><div class="flex justify-between items-start mb-4"><h2 class="text-2xl font-bold text-gray-800">Loan Analysis for <span id="analysisLoanName" class="text-blue-600"></span></h2><div class="flex space-x-2"><button id="downloadLoanPdfBtn" class="btn btn-secondary">Report (PDF)</button><button id="downloadLoanExcelBtn" class="btn btn-primary">Schedule (Excel)</button></div></div><div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6"><div class="input-group"><label for="plannedEMI">Your Planned EMI</label><input type="number" id="plannedEMI"></div><div class="input-group"><label for="adhocPayment">Adhoc Bulk Payment (This Month)</label><input type="number" id="adhocPayment" value="0"></div><div class="flex items-end pb-4"><button id="recalculateBtn" class="btn btn-secondary w-full">Recalculate Projections</button></div></div><div id="report-loan-summary"> <div class="bg-gray-50 p-4 rounded-lg mb-6"><h3 class="text-lg font-semibold text-gray-700 mb-4">Repayment Projections</h3><div class="grid grid-cols-1 sm:grid-cols-3 gap-4 text-center"><div><p class="text-sm text-gray-500">Projected Finish Time</p><p id="projectedMonths" class="text-xl font-bold text-blue-600">-</p></div><div><p class="text-sm text-gray-500">Projected Total Interest</p><p id="projectedInterest" class="text-xl font-bold text-blue-600">-</p></div><div><p class="text-sm text-gray-500">Original Total Interest</p><p id="originalInterest" class="text-xl font-bold text-gray-600">-</p></div></div></div><div class="grid grid-cols-1 xl:grid-cols-2 gap-8"><div><h3 class="text-lg font-semibold text-gray-700 mb-4">Prepayment Scenarios (Interest Saved)</h3><table class="w-full text-left"><thead class="bg-gray-100"><tr><th class="p-3 font-semibold text-sm">EMI Increase</th><th class="p-3 font-semibold text-sm">New EMI</th><th class="p-3 font-semibold text-sm">Total Interest Paid</th><th class="p-3 font-semibold text-sm text-green-600">Interest Saved</th></tr></thead><tbody id="interestReductionTable"></tbody></table></div><div id="amortization-section-container"> <h3 class="text-lg font-semibold text-gray-700 mb-4">Amortization Schedule</h3><div class="h-96 overflow-y-auto border rounded-lg"><table class="w-full text-left text-sm"><thead class="bg-gray-100 sticky top-0"><tr><th class="p-2 font-semibold">Month</th><th class="p-2 font-semibold">Opening</th><th class="p-2 font-semibold">Interest</th><th class="p-2 font-semibold">Principal</th><th class="p-2 font-semibold">Closing</th></tr></thead><tbody id="amortizationTableBody"></tbody></table></div></div></div></div></div></div></div>

        <!-- Calculators Tab -->
        <div id="calculatorsTab" class="hidden pt-4">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- EMI Calculator -->
                <div class="card"><h3 class="text-xl font-bold text-gray-700 mb-4">EMI Calculator <span class="helper-icon" data-help="emi">?</span></h3><form id="emiCalcForm"><div class="input-group"><label for="emiLoanAmount">Loan Amount (<span id="emiLoanAmountDisplay"></span>)</label><div class="flex items-center space-x-2"><input type="number" id="emiLoanAmount" class="w-2/5" required><input type="range" id="emiLoanAmountSlider" class="w-3/5" min="10000" max="50000000" step="10000"></div></div><div class="input-group"><label for="emiInterestRate">Interest Rate (%) (<span id="emiInterestRateDisplay"></span>)</label><div class="flex items-center space-x-2"><input type="number" id="emiInterestRate" step="0.01" class="w-2/5" required><input type="range" id="emiInterestRateSlider" class="w-3/5" min="1" max="25" step="0.01"></div></div><div class="input-group"><label for="emiTenure">Tenure (Years) (<span id="emiTenureDisplay"></span>)</label><div class="flex items-center space-x-2"><input type="number" id="emiTenure" class="w-2/5" required><input type="range" id="emiTenureSlider" class="w-3/5" min="1" max="30" step="1"></div></div><button type="submit" class="btn btn-primary w-full">Calculate EMI</button></form><div id="emiResult" class="calc-result hidden"></div></div>
                <!-- Home Affordability -->
                <div class="card"><h3 class="text-xl font-bold text-gray-700 mb-4">Home Affordability <span class="helper-icon" data-help="affordability">?</span></h3><form id="haForm"><div class="input-group"><label for="haMonthlyIncome">Gross Monthly Income (<span id="haMonthlyIncomeDisplay"></span>)</label><div class="flex items-center space-x-2"><input type="number" id="haMonthlyIncome" class="w-2/5" required><input type="range" id="haMonthlyIncomeSlider" class="w-3/5" min="10000" max="1000000" step="5000"></div></div><div class="input-group"><label for="haExistingEmi">Total Existing EMIs (<span id="haExistingEmiDisplay"></span>)</label><div class="flex items-center space-x-2"><input type="number" id="haExistingEmi" value="0" class="w-2/5" required><input type="range" id="haExistingEmiSlider" class="w-3/5" min="0" max="500000" step="1000"></div></div><div class="input-group"><label for="haTenure">Desired Loan Tenure (Years) (<span id="haTenureDisplay"></span>)</label><div class="flex items-center space-x-2"><input type="number" id="haTenure" value="20" class="w-2/5" required><input type="range" id="haTenureSlider" class="w-3/5" min="1" max="30" step="1"></div></div><div class="input-group"><label for="haInterestRate">Assumed Interest Rate (%) (<span id="haInterestRateDisplay"></span>)</label><div class="flex items-center space-x-2"><input type="number" step="0.01" id="haInterestRate" value="8.5" class="w-2/5" required><input type="range" id="haInterestRateSlider" class="w-3/5" min="1" max="25" step="0.01"></div></div><button type="submit" class="btn btn-primary w-full">Calculate Affordability</button></form><div id="haResult" class="hidden mt-4"></div></div>
                <!-- Investment Simulator -->
                <div class="card"><h3 class="text-xl font-bold text-gray-700 mb-4">Investment Simulator <span class="helper-icon" data-help="simulator">?</span></h3><form id="sipForm"><div class="input-group"><label for="sipAmount">Monthly Investment (SIP) (<span id="sipAmountDisplay"></span>)</label><div class="flex items-center space-x-2"><input type="number" id="sipAmount" class="w-2/5" required><input type="range" id="sipAmountSlider" class="w-3/5" min="500" max="100000" step="500"></div></div><div class="input-group"><label for="sipReturnRate">Expected Annual Return (%) (<span id="sipReturnRateDisplay"></span>)</label><div class="flex items-center space-x-2"><input type="number" id="sipReturnRate" step="0.1" class="w-2/5" required><input type="range" id="sipReturnRateSlider" class="w-3/5" min="1" max="30" step="0.1"></div></div><div class="input-group"><label for="sipDuration">Investment Duration (Years) (<span id="sipDurationDisplay"></span>)</label><div class="flex items-center space-x-2"><input type="number" id="sipDuration" class="w-2/5" required><input type="range" id="sipDurationSlider" class="w-3/5" min="1" max="40" step="1"></div></div><button type="submit" class="btn btn-primary w-full">Simulate Growth</button></form><div id="sipResult" class="hidden mt-4"></div></div>
            </div>
        </div>

        <footer class="text-center text-sm text-gray-500 mt-8">
            <a href="#" id="privacyPolicyLink" class="hover:underline">Privacy Policy</a>
        </footer>

    </div>
    
    <!-- Generic Modal -->
    <div id="modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 id="modalTitle" class="text-xl font-bold"></h3>
                <button id="closeModalBtn" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            </div>
            <div id="modalBody"></div>
        </div>
    </div>

    <script>
        // --- DATA STORAGE ---
        let loans = [], assets = [], goals = [], insurances = [], incomes = [], wants = [];
        let activeAnalysisIndex = -1;
        let budgetChart, wealthGrowthChart;
        let currentAmortizationSchedule = [];
        let db;

        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyBPFwbue19VG1qu8XnsI0aqNWGsJgZAqWI",
            authDomain: "wealth-planner-app-e3274.firebaseapp.com",
            projectId: "wealth-planner-app-e3274",
            storageBucket: "wealth-planner-app-e3274.appspot.com",
            messagingSenderId: "600542647882",
            appId: "1:600542647882:web:f348cb568b900139d078b3",
            measurementId: "G-1KH7RMR8QG"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        db = firebase.firestore();

        // --- DOM ELEMENTS ---
        const currentAgeInput = document.getElementById('currentAge');

        // --- TABS ---
        function showTab(tabName) {
            document.getElementById('dashboardTab').classList.toggle('hidden', tabName !== 'dashboard');
            document.getElementById('inputsTab').classList.toggle('hidden', tabName !== 'inputs');
            document.getElementById('loansTab').classList.toggle('hidden', tabName !== 'loans');
            document.getElementById('calculatorsTab').classList.toggle('hidden', tabName !== 'calculators');
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`.nav-tab[onclick="showTab('${tabName}')"]`).classList.add('active');
        }

        // --- FORMATTING ---
        function formatLargeCurrency(value) { if (isNaN(value)) return 'â‚¹0'; if (value >= 10000000) { return `â‚¹${(value / 10000000).toFixed(2)} Cr`; } if (value >= 100000) { return `â‚¹${(value / 100000).toFixed(2)} L`; } return new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR', minimumFractionDigits: 0 }).format(value); }
        const formatCurrency = (value) => new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR', minimumFractionDigits: 0 }).format(value);

        // --- RENDER FUNCTIONS ---
        function renderAllLists() {
            const loanListEl = document.getElementById('loanList'); if (loans.length > 0) loanListEl.innerHTML = loans.map((loan, index) => `<div class="flex items-center justify-between p-3 border rounded-lg bg-white shadow-sm"><div><p class="font-bold text-gray-800">${loan.name}</p><p class="text-sm text-gray-600">Principal: ${formatCurrency(loan.principal)} | EMI: ${formatCurrency(loan.emi)}</p></div><div class="flex space-x-2"><button class="btn btn-primary text-sm py-2 px-3" onclick="analyzeLoan(${index})">Analyze</button><button class="btn btn-danger text-sm py-2 px-3" onclick="deleteItem('loans', ${index})">Delete</button></div></div>`).join(''); else loanListEl.innerHTML = `<p class="text-gray-500 text-center">No loans added.</p>`;
            const assetListEl = document.getElementById('assetList'); if (assets.length > 0) assetListEl.innerHTML = assets.map((a, i) => `<div class="text-sm p-1 border-t mt-2"><div><span class="font-bold">${a.name} (${a.type})</span> <button class="text-red-500 ml-2 font-bold float-right" onclick="deleteItem('assets', ${i})">X</button></div><div>Value: ${formatCurrency(a.value)} | SIP: ${formatCurrency(a.monthlySip)}/mo</div></div>`).join(''); else assetListEl.innerHTML = ``;
            const goalListEl = document.getElementById('goalList'); if (goals.length > 0) goalListEl.innerHTML = goals.map((g, i) => `<div class="text-sm flex justify-between p-1"><span>${g.name}</span> <span class="font-medium">${formatLargeCurrency(g.amount)} <button class="text-red-500 ml-2 font-bold" onclick="deleteItem('goals', ${i})">X</button></span></div>`).join(''); else goalListEl.innerHTML = ``;
            const insuranceListEl = document.getElementById('insuranceList'); if (insurances.length > 0) insuranceListEl.innerHTML = insurances.map((ins, i) => `<div class="text-sm p-1 border-t mt-2"><div><span class="font-bold">${ins.type}</span> <button class="text-red-500 ml-2 font-bold float-right" onclick="deleteItem('insurances', ${i})">X</button></div><div>Cover: ${formatLargeCurrency(ins.cover)} | Premium: ${formatCurrency(ins.premiumAmount)}/${ins.premiumFrequency}</div></div>`).join(''); else insuranceListEl.innerHTML = ``;
            const incomeListEl = document.getElementById('incomeList'); if(incomes.length > 0) incomeListEl.innerHTML = incomes.map((inc, i) => `<div class="text-sm flex justify-between p-1 border-t mt-2"><span>${inc.source}</span><span class="font-medium">${formatCurrency(inc.amount)} <button class="text-red-500 ml-2 font-bold" onclick="deleteItem('incomes', ${i})">X</button></span></div>`).join(''); else incomeListEl.innerHTML = '';
            const wantsListEl = document.getElementById('wantsList'); if(wants.length > 0) wantsListEl.innerHTML = wants.map((w, i) => `<div class="text-sm flex justify-between p-1 border-t mt-2"><span>${w.category}</span><span class="font-medium">${formatCurrency(w.amount)} <button class="text-red-500 ml-2 font-bold" onclick="deleteItem('wants', ${i})">X</button></span></div>`).join(''); else wantsListEl.innerHTML = '';
        }
        
        // --- ANALYSIS & DASHBOARD ---
        function calculateAmortization(principal, monthlyRate, plannedEMI, adhocPayment = 0) {let schedule = [], openingBalance = principal - adhocPayment, totalInterest = 0, month = 1; if(openingBalance <= 0) return { schedule: [{ month: 1, opening: principal, interest: 0, principalPaid: principal, closing: 0 }], totalInterest: 0, months: 1 }; while (openingBalance > 0) { const interestForMonth = openingBalance * monthlyRate; let paymentForMonth = Math.min(plannedEMI, openingBalance + interestForMonth); if (openingBalance < plannedEMI) { paymentForMonth = openingBalance + interestForMonth; } const principalPaid = paymentForMonth - interestForMonth; const closingBalance = openingBalance - principalPaid; schedule.push({ month, opening: openingBalance, interest: interestForMonth, principalPaid, closing: closingBalance }); totalInterest += interestForMonth; openingBalance = closingBalance; month++; if (month > 1200) break; } return { schedule, totalInterest, months: month - 1 };}
        function runFullLoanAnalysis(loan) {const plannedEMI = parseFloat(document.getElementById('plannedEMI').value) || loan.emi; const adhocPayment = parseFloat(document.getElementById('adhocPayment').value) || 0; const monthlyRate = loan.rate / 12 / 100; const originalResult = calculateAmortization(loan.principal, monthlyRate, loan.emi); document.getElementById('originalInterest').textContent = formatLargeCurrency(originalResult.totalInterest); const newResult = calculateAmortization(loan.principal, monthlyRate, plannedEMI, adhocPayment); document.getElementById('projectedMonths').textContent = `${newResult.months} months (${(newResult.months/12).toFixed(1)} years)`; document.getElementById('projectedInterest').textContent = formatLargeCurrency(newResult.totalInterest); currentAmortizationSchedule = newResult.schedule; renderAmortizationTable(newResult.schedule); renderInterestReductionTable(loan, originalResult.totalInterest);}
        function renderAmortizationTable(schedule) {document.getElementById('amortizationTableBody').innerHTML = schedule.map(row => `<tr class="border-b"><td class="p-2">${row.month}</td><td class="p-2">${formatCurrency(row.opening)}</td><td class="p-2 text-red-600">${formatCurrency(row.interest)}</td><td class="p-2 text-green-600">${formatCurrency(row.principalPaid)}</td><td class="p-2">${formatCurrency(row.closing)}</td></tr>`).join('');}
        function renderInterestReductionTable(loan, originalTotalInterest) {const scenarios = [{ label: '+ 5%', increase: 1.05 },{ label: '+ 10%', increase: 1.10 },{ label: '+ 20%', increase: 1.20 },{ label: '+ 50%', increase: 1.50 }]; const monthlyRate = loan.rate / 12 / 100; let tableHtml = `<tr class="bg-gray-50 font-semibold"><td class="p-3">Baseline</td><td class="p-3">${formatCurrency(loan.emi)}</td><td class="p-3">${formatLargeCurrency(originalTotalInterest)}</td><td class="p-3 text-gray-500">-</td></tr>`; scenarios.forEach(scenario => {const newEmi = loan.emi * scenario.increase; const result = calculateAmortization(loan.principal, monthlyRate, newEmi); const interestSaved = originalTotalInterest - result.totalInterest; tableHtml += `<tr><td class="p-3">${scenario.label}</td><td class="p-3">${formatCurrency(newEmi)}</td><td class="p-3">${formatLargeCurrency(result.totalInterest)}</td><td class="p-3 font-bold text-green-600">${formatLargeCurrency(interestSaved)}</td></tr>`;}); document.getElementById('interestReductionTable').innerHTML = tableHtml;}
        
        function updateDashboard() {
            const totalMonthlyIncome = incomes.reduce((sum, i) => sum + i.amount, 0);
            if (totalMonthlyIncome === 0) { document.getElementById('noDataOverlay').classList.add('active'); return; }
            document.getElementById('noDataOverlay').classList.remove('active');

            const totalMonthlyWants = wants.reduce((sum, w) => sum + w.amount, 0);
            const totalEMI = loans.reduce((sum, loan) => sum + loan.emi, 0);
            const totalMonthlyPremiums = insurances.reduce((sum, ins) => sum + (ins.premiumFrequency === 'monthly' ? ins.premiumAmount : ins.premiumAmount / 12), 0);
            const totalMonthlySips = assets.reduce((sum, a) => sum + a.monthlySip, 0);
            
            const monthlyNeeds = totalEMI + totalMonthlyPremiums; 
            const potentialExtraSavings = totalMonthlyIncome - monthlyNeeds - totalMonthlyWants - totalMonthlySips;
            const totalAssets = assets.reduce((sum, a) => sum + a.value, 0);
            const totalLiabilities = loans.reduce((sum, l) => sum + l.principal, 0);
            const netWorth = totalAssets - totalLiabilities;
            
            let score = 0;
            const totalSavingsAndInvestments = potentialExtraSavings + totalMonthlySips;
            const savingsRate = totalMonthlyIncome > 0 ? totalSavingsAndInvestments / totalMonthlyIncome : 0; score += Math.min(30, (savingsRate / 0.20) * 30); 
            const dtiRatio = totalMonthlyIncome > 0 ? (totalEMI / totalMonthlyIncome) * 100 : 0; score += Math.max(0, (1 - dtiRatio / 50) * 30); 
            const liquidAssets = assets.filter(a => ['bank', 'stocks', 'mf', 'chits'].includes(a.type)).reduce((sum, a) => sum + a.value, 0); 
            const monthlyExpenses = monthlyNeeds + totalMonthlyWants; 
            const emergencyFundRatio = monthlyExpenses > 0 ? liquidAssets / (monthlyExpenses * 6) : 0; score += Math.min(20, emergencyFundRatio * 20); 
            if (assets.length > 1) score += 10; 
            if (insurances.some(i => i.type === 'Health' || i.type === 'Term')) score += 10; 
            score = Math.round(Math.max(0, Math.min(100, score)));
            
            renderGauge(score);
            renderDtiGauge(dtiRatio);
            renderFinancialVitals({ totalMonthlyIncome, totalMonthlySips, totalEMI, potentialExtraSavings });
            const budgetData = {labels: [`Needs (${formatCurrency(monthlyNeeds)})`, `Wants (${formatCurrency(totalMonthlyWants)})`, `Investments (${formatCurrency(totalSavingsAndInvestments)})`], datasets: [{ data: [monthlyNeeds, totalMonthlyWants, Math.max(0, totalSavingsAndInvestments)], backgroundColor: ['#ef4444', '#f59e0b', '#22c55e'] }]}; renderChart('budgetChart', 'doughnut', budgetData, { responsive: true, maintainAspectRatio: true, plugins: { legend: { position: 'top' } } });
            
            const weightedAvgReturn = totalAssets > 0 ? assets.reduce((sum, a) => sum + a.value * (a.returnRate / 100), 0) / totalAssets : 0.05; 
            let projection = []; let currentWealth = netWorth; 
            const currentYear = new Date().getFullYear();
            for (let i = 0; i <= 10; i++) { projection.push(currentWealth); currentWealth = currentWealth * (1 + weightedAvgReturn) + (totalSavingsAndInvestments * 12); } 
            const wealthData = {labels: Array.from({length: 11}, (_, i) => `${currentYear + i}`), datasets: [{ label: 'Projected Net Worth', data: projection, borderColor: '#3b82f6', tension: 0.1, fill: false }]}; renderChart('wealthGrowthChart', 'line', wealthData, { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { ticks: { callback: value => formatLargeCurrency(value) } } } });

            renderGoalPlanner(weightedAvgReturn);
            renderRetirementPlanner(weightedAvgReturn);
            renderInputsForPDF();
            renderSuggestions({emergencyFundRatio, liquidAssets, monthlyExpenses, yearlyIncome: totalMonthlyIncome * 12});
            renderWealthGrowthExplanation({netWorth, totalSavingsAndInvestments, weightedAvgReturn});
            renderBudgetRuleExplanation({ needsPercent: (monthlyNeeds / totalMonthlyIncome) * 100, wantsPercent: (totalMonthlyWants / totalMonthlyIncome) * 100, savingsPercent: (totalSavingsAndInvestments / totalMonthlyIncome) * 100, totalMonthlyIncome });
        }
        
        function renderFinancialVitals({ totalMonthlyIncome, totalMonthlySips, totalEMI, potentialExtraSavings }) { const container = document.getElementById('financialVitalsContainer'); container.innerHTML = `<div class="vitals-card"><div class="label">Total Monthly Income</div><div class="value text-green-600">${formatCurrency(totalMonthlyIncome)}</div></div><div class="vitals-card"><div class="label">Total Monthly Investments</div><div class="value text-blue-600">${formatCurrency(totalMonthlySips)}</div></div><div class="vitals-card"><div class="label">Total Monthly EMI</div><div class="value text-red-600">${formatCurrency(totalEMI)}</div></div><div class="vitals-card"><div class="label">Potential Extra Savings</div><div class="value text-yellow-500">${formatCurrency(potentialExtraSavings)}</div></div>`; }
        function renderSuggestions({emergencyFundRatio, liquidAssets, monthlyExpenses, yearlyIncome}) { const container = document.getElementById('suggestionsContainer'); let html = ''; if (emergencyFundRatio < 1) { const targetFund = monthlyExpenses * 6; html += `<div class="suggestion-card"><strong>Emergency Fund Alert:</strong> Your fund is at ${formatCurrency(liquidAssets)}. It is recommended to have at least 6 months of expenses (${formatCurrency(targetFund)}) for financial security.</div>`; } if (!insurances.some(i => i.type === 'Health')) { html += `<div class="suggestion-card"><strong>Health Insurance Gap:</strong> A health insurance policy is crucial to protect your savings from unexpected medical emergencies. Consider getting a family floater plan.</div>`; } if (!insurances.some(i => i.type === 'Term')) { const targetCover = yearlyIncome * 15; html += `<div class="suggestion-card"><strong>Term Insurance Recommended:</strong> To protect your family's future, a term plan of at least 10-15 times your annual income (${formatLargeCurrency(targetCover)}) is advisable.</div>`; } if(html === '') { html = '<p class="text-center text-gray-600">You are on the right track with your core financial safety net. Keep it up!</p>'; } container.innerHTML = html; }
        function renderWealthGrowthExplanation({netWorth, totalSavingsAndInvestments, weightedAvgReturn}) { const container = document.getElementById('wealthGrowthExplanation'); container.innerHTML = `This projection starts with your current Net Worth of <strong>${formatLargeCurrency(netWorth)}</strong>. Each year, it grows based on an estimated <strong>${(weightedAvgReturn * 100).toFixed(1)}%</strong> average annual return and your annual contributions of <strong>${formatLargeCurrency(totalSavingsAndInvestments * 12)}</strong>. This demonstrates the power of compounding over time.`; }
        function renderGoalPlanner(weightedAvgReturn) { const goalPlannerEl = document.getElementById('goalPlanner'); if (goals.length === 0) { goalPlannerEl.innerHTML = `<p class="text-gray-500 text-center">Add goals in 'Financial Inputs' to see your plan.</p>`; return; } goalPlannerEl.innerHTML = goals.map(g => { const monthlyInvRate = (weightedAvgReturn || 0.08) / 12; const n = g.years * 12; if(monthlyInvRate <= 0) return `<div class="p-3 bg-gray-50 rounded-lg"><span class="font-semibold text-center">Cannot calculate SIP for ${g.name} without a positive return.</span></div>`; const requiredSip = g.amount * (monthlyInvRate / (Math.pow(1 + monthlyInvRate, n) - 1)); return `<div class="p-3 bg-gray-50 rounded-lg grid grid-cols-1 sm:grid-cols-3 items-center text-center sm:text-left"><span class="font-semibold">${g.name}</span><span>Target: ${formatLargeCurrency(g.amount)} in ${g.years} yrs</span><span class="sm:text-right font-bold text-blue-600">Req. SIP: ${formatCurrency(requiredSip)}/mo</span></div>`; }).join(''); }
        function renderRetirementPlanner(weightedAvgReturn) { const retirementPlannerEl = document.getElementById('retirementPlanner'); const currentAge = parseInt(currentAgeInput.value) || 0; const retirementAge = 60; if (currentAge === 0) { retirementPlannerEl.innerHTML = `<p class="text-gray-500 text-center">Enter your current age in 'Financial Inputs' for a retirement plan.</p>`; return; } const yearsToRetire = retirementAge - currentAge; if (yearsToRetire <= 0) { retirementPlannerEl.innerHTML = `<p class="text-gray-500 text-center">Retirement age reached or passed.</p>`; return; } const yearlyExpenses = wants.reduce((sum, w) => sum + w.amount, 0) * 12; const targetCorpus = yearlyExpenses / 0.04; const monthlyInvRate = (weightedAvgReturn || 0.08) / 12; const n = yearsToRetire * 12; const currentNetWorth = assets.reduce((sum, a) => sum + a.value, 0) - loans.reduce((sum, l) => sum + l.principal, 0); const fvOfCurrent = currentNetWorth * Math.pow(1 + monthlyInvRate, n); const totalMonthlySavings = incomes.reduce((sum, i) => sum + i.amount, 0) - (loans.reduce((sum, l) => sum + l.emi, 0) + insurances.reduce((sum, i) => sum + (i.premiumFrequency === 'monthly' ? i.premiumAmount : i.premiumAmount / 12), 0)) - wants.reduce((sum, w) => sum + w.amount, 0); const fvOfSips = totalMonthlySavings * ((Math.pow(1 + monthlyInvRate, n) - 1) / monthlyInvRate); const totalFutureValue = fvOfCurrent + fvOfSips; const shortfall = targetCorpus - totalFutureValue; retirementPlannerEl.innerHTML = `<div class="p-3 bg-blue-50 rounded-lg grid grid-cols-1 sm:grid-cols-3 items-center text-center sm:text-left"><span class="font-semibold">Retirement at ${retirementAge}</span><span>Target Corpus: ${formatLargeCurrency(targetCorpus)}</span>${shortfall > 0 ? `<span class="sm:text-right font-bold text-red-600">Shortfall: ${formatLargeCurrency(shortfall)}</span>` : `<span class="sm:text-right font-bold text-green-600">On Track!</span>`}</div>`; }
        function renderBudgetRuleExplanation({ needsPercent, wantsPercent, savingsPercent, totalMonthlyIncome }) { const container = document.getElementById('budgetRuleExplanation'); let html = `<p class="mb-2">The <strong>50-30-20 rule</strong> is a simple budgeting guideline: allocate <strong>50%</strong> of your income to Needs (essentials like EMIs, premiums), <strong>30%</strong> to Wants (lifestyle spending), and <strong>20%</strong> to Savings & Investments.</p>`; html += `<p class="mb-2"><strong>Your current breakdown is:</strong></p><ul class="list-disc list-inside mb-4"><li><strong>Needs:</strong> ${needsPercent.toFixed(1)}%</li><li><strong>Wants:</strong> ${wantsPercent.toFixed(1)}%</li><li><strong>Savings:</strong> ${savingsPercent.toFixed(1)}%</li></ul><h4 class="font-semibold mb-2">How to align with the rule:</h4>`; if (savingsPercent < 20) { html += `<div class="suggestion-card">Your savings rate of ${savingsPercent.toFixed(1)}% is below the recommended 20%. Try to increase this by reducing 'Wants' or optimizing 'Needs'. Every extra rupee saved accelerates your wealth growth.</div>`; } if (wantsPercent > 30) { const excess = (wantsPercent - 30) / 100 * totalMonthlyIncome; html += `<div class="suggestion-card">Your spending on 'Wants' is at ${wantsPercent.toFixed(1)}%. Consider reducing this by about <strong>${formatCurrency(excess)}/month</strong> to meet the 30% target and boost your savings.</div>`; } if (needsPercent > 50) { html += `<div class="suggestion-card">Your 'Needs' are at ${needsPercent.toFixed(1)}%. While often fixed, see if high-interest loans can be refinanced or if insurance premiums can be optimized (e.g., paying annually).</div>`; } if (savingsPercent >= 20 && wantsPercent <= 30 && needsPercent <= 50) { html += `<div class="suggestion-card bg-green-100 border-green-500"><strong>Excellent!</strong> Your budget aligns well with the 50-30-20 rule. You are doing a great job managing your cash flow.</div>`; } container.innerHTML = html; }
        function renderInputsForPDF() { const container = document.getElementById('report-section-inputs'); let html = `<h3 class="pdf-section-header">Financial Inputs Summary</h3><table class="w-full text-sm text-left"><tr><td class="p-2 font-semibold">Current Age</td><td class="p-2">${currentAgeInput.value || 'N/A'}</td></tr></table>`; if(incomes.length > 0) {html += `<h4 class="font-semibold mt-4 mb-2">Incomes</h4><table class="w-full text-sm text-left"><thead><tr class="bg-gray-100"><th class="p-2">Source</th><th class="p-2">Amount/mo</th></tr></thead><tbody>`; incomes.forEach(i => {html += `<tr><td class="p-2 border-b">${i.source}</td><td class="p-2 border-b">${formatCurrency(i.amount)}</td></tr>`}); html += `</tbody></table>`;} if(wants.length > 0) {html += `<h4 class="font-semibold mt-4 mb-2">Wants</h4><table class="w-full text-sm text-left"><thead><tr class="bg-gray-100"><th class="p-2">Category</th><th class="p-2">Amount/mo</th></tr></thead><tbody>`; wants.forEach(w => {html += `<tr><td class="p-2 border-b">${w.category}</td><td class="p-2 border-b">${formatCurrency(w.amount)}</td></tr>`}); html += `</tbody></table>`;} if (assets.length > 0) { html += `<h4 class="font-semibold mt-4 mb-2">Assets</h4><table class="w-full text-sm text-left"><thead><tr class="bg-gray-100"><th class="p-2">Name</th><th class="p-2">Value</th><th class="p-2">SIP/mo</th></tr></thead><tbody>`; assets.forEach(a => { html += `<tr><td class="p-2 border-b">${a.name} (${a.type})</td><td class="p-2 border-b">${formatCurrency(a.value)}</td><td class="p-2 border-b">${formatCurrency(a.monthlySip)}</td></tr>`; }); html += `</tbody></table>`; } if (loans.length > 0) { html += `<h4 class="font-semibold mt-4 mb-2">Loans</h4><table class="w-full text-sm text-left"><thead><tr class="bg-gray-100"><th class="p-2">Name</th><th class="p-2">Principal Left</th><th class="p-2">EMI</th></tr></thead><tbody>`; loans.forEach(l => { html += `<tr><td class="p-2 border-b">${l.name}</td><td class="p-2 border-b">${formatCurrency(l.principal)}</td><td class="p-2 border-b">${formatCurrency(l.emi)}</td></tr>`; }); html += `</tbody></table>`; } if (insurances.length > 0) { html += `<h4 class="font-semibold mt-4 mb-2">Insurance Policies</h4><table class="w-full text-sm text-left"><thead><tr class="bg-gray-100"><th class="p-2">Type</th><th class="p-2">Cover</th><th class="p-2">Premium</th></tr></thead><tbody>`; insurances.forEach(i => { html += `<tr><td class="p-2 border-b">${i.type}</td><td class="p-2 border-b">${formatLargeCurrency(i.cover)}</td><td class="p-2 border-b">${formatCurrency(i.premiumAmount)} / ${i.premiumFrequency}</td></tr>`; }); html += `</tbody></table>`; } container.innerHTML = html; }

        function renderChart(canvasId, type, data, options) {const ctx = document.getElementById(canvasId).getContext('2d'); let chartInstance = Chart.getChart(canvasId); if (chartInstance) chartInstance.destroy(); new Chart(ctx, { type, data, options });}
        function renderGauge(score) {const gaugeEl = document.getElementById('financialScoreGauge'); const color = score < 40 ? '#ef4444' : score < 70 ? '#f59e0b' : '#22c55e'; const deg = (score / 100) * 180; gaugeEl.innerHTML = `<div style="width:150px; height:75px; position:relative; overflow:hidden;"><div style="position:absolute; width:150px; height:150px; border-radius:50%; border: 20px solid #e5e7eb; border-bottom-color:transparent; border-left-color:transparent; border-right-color:transparent; transform: rotate(-135deg);"></div><div style="position:absolute; width:150px; height:150px; border-radius:50%; border: 20px solid ${color}; border-top-color:transparent; border-left-color:transparent; border-right-color:transparent; transform: rotate(45deg) rotate(${deg}deg); transition: transform 0.5s;"></div><div class="absolute inset-0 flex items-end justify-center text-2xl font-bold" style="color:${color}">${score}</div></div>`;}
        function renderDtiGauge(dti) { const gaugeEl = document.getElementById('dtiRatioGauge'); const color = dti > 50 ? '#ef4444' : dti > 40 ? '#f59e0b' : '#22c55e'; gaugeEl.textContent = `${dti.toFixed(1)}%`; gaugeEl.style.color = color; }

        // --- EXCEL/CSV DOWNLOAD FUNCTION ---
        function downloadCSV(data, filename) { if (!data || data.length === 0) { alert('No data to download.'); return; } const allHeaders = new Set(); data.forEach(row => { Object.keys(row).forEach(key => allHeaders.add(key)); }); const headers = Array.from(allHeaders); const csvRows = [headers.join(',')]; for (const row of data) { const values = headers.map(header => { const value = row[header] === undefined || row[header] === null ? '' : row[header]; const escaped = ('' + value).replace(/"/g, '""'); return `"${escaped}"`; }); csvRows.push(values.join(',')); } const csvString = csvRows.join('\n'); const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' }); const link = document.createElement('a'); const url = URL.createObjectURL(blob); link.setAttribute('href', url); link.setAttribute('download', filename); link.style.visibility = 'hidden'; document.body.appendChild(link); link.click(); document.body.removeChild(link); }

        // --- PDF DOWNLOAD FUNCTIONS ---
        async function downloadPDF(buttonId, type) {
            const { jsPDF } = window.jspdf;
            const downloadBtn = document.getElementById(buttonId);
            const now = new Date();
            const timestamp = `${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}_${String(now.getHours()).padStart(2, '0')}${String(now.getMinutes()).padStart(2, '0')}${String(now.getSeconds()).padStart(2, '0')}`;
            const filename = `${type}_Report_${timestamp}.pdf`;
            
            downloadBtn.textContent = 'Generating...'; downloadBtn.disabled = true;
            try {
                const pdf = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
                const page_margin = 15; const pdfWidth = pdf.internal.pageSize.getWidth() - (page_margin * 2); let yPos = page_margin;
                pdf.setFontSize(20).text(`${type} Report`, pdf.internal.pageSize.getWidth() / 2, yPos, { align: 'center' }); yPos += 10;
                pdf.setFontSize(10).text(`Generated on: ${now.toLocaleDateString('en-IN')} ${now.toLocaleTimeString('en-IN')}`, pdf.internal.pageSize.getWidth() / 2, yPos, { align: 'center' }); yPos += 15;

                let elementsToProcess = [];
                 if (type === 'Wealth') {
                    elementsToProcess = ['report-section-inputs', 'report-section-summary', 'report-section-vitals', 'report-section-budget-explanation', 'report-section-suggestions', 'report-section-wealth', 'report-section-retirement', 'report-section-goals'].map(id => document.getElementById(id));
                } else if (type === 'Loan') {
                    const tempAmortizationEl = document.createElement('div');
                    tempAmortizationEl.innerHTML = document.getElementById('amortization-section-container').innerHTML;
                    tempAmortizationEl.querySelector('.overflow-y-auto').style.height = 'auto'; 
                    tempAmortizationEl.querySelector('.overflow-y-auto').style.overflowY = 'visible';
                    document.body.appendChild(tempAmortizationEl);
                    elementsToProcess.push(document.getElementById('report-loan-summary'), tempAmortizationEl);
                }

                for (const element of elementsToProcess) {
                    if (!element) continue;
                    const wasHidden = element.classList.contains('hidden');
                    if (wasHidden) element.classList.remove('hidden');
                    
                    const canvas = await html2canvas(element, { scale: 2, useCORS: true, logging: false, backgroundColor: '#ffffff' });
                    
                    if (wasHidden) element.classList.add('hidden');

                    const imgData = canvas.toDataURL('image/jpeg', 0.95); const imgProps = pdf.getImageProperties(imgData); const imgHeight = (imgProps.height * pdfWidth) / imgProps.width;
                    if (yPos + imgHeight > pdf.internal.pageSize.getHeight() - page_margin) { pdf.addPage(); yPos = page_margin; }
                    pdf.addImage(imgData, 'JPEG', page_margin, yPos, pdfWidth, imgHeight, undefined, 'MEDIUM'); yPos += imgHeight + 10; 
                }

                 if (type === 'Loan' && elementsToProcess[1] && document.body.contains(elementsToProcess[1])) {
                    document.body.removeChild(elementsToProcess[1]); 
                }
                
                 // Add Footer
                const pageCount = pdf.internal.getNumberOfPages();
                for(let i = 1; i <= pageCount; i++) {
                    pdf.setPage(i);
                    pdf.setFontSize(8).text('Generated using Amigos - Finance Planner App', pdf.internal.pageSize.getWidth() / 2, pdf.internal.pageSize.getHeight() - 5, { align: 'center' });
                }

                pdf.save(filename);
            } catch (error) { console.error("Error generating PDF:", error); alert("An error occurred while generating the PDF report."); } 
            finally { downloadBtn.textContent = `Download ${type} Report`; downloadBtn.disabled = false; }
        }
        
        // --- EVENT HANDLERS ---
        function setupDynamicSelect(form, selectClass, inputClass) {
            const select = form.querySelector(selectClass);
            const customInput = form.querySelector(inputClass);
            select.addEventListener('change', () => { customInput.classList.toggle('hidden', select.value !== 'Other'); });
        }
        function setupSlider(inputId, sliderId, displayId, formatter = (val) => val) {
            const input = document.getElementById(inputId);
            const slider = document.getElementById(sliderId);
            const display = document.getElementById(displayId);
            const update = (value) => {
                input.value = value;
                slider.value = value;
                if(display) display.textContent = formatter(value);
            };
            if(input) input.addEventListener('input', () => update(input.value));
            if(slider) slider.addEventListener('input', () => update(slider.value));
            if(input && slider) update(input.value || slider.value); // Initial sync
        }
        window.deleteItem = (type, index) => { if (confirm('Are you sure?')) { if (type === 'loans') {loans.splice(index, 1); if(activeAnalysisIndex === index) {document.getElementById('detailedAnalysisSection').classList.add('hidden'); activeAnalysisIndex = -1;}} if (type === 'assets') assets.splice(index, 1); if (type === 'goals') goals.splice(index, 1); if (type === 'insurances') insurances.splice(index, 1); if(type === 'incomes') incomes.splice(index, 1); if(type === 'wants') wants.splice(index, 1); renderAllLists(); updateDashboard(); } }
        window.analyzeLoan = (index) => {activeAnalysisIndex = index; const loan = loans[index]; document.getElementById('analysisLoanName').textContent = loan.name; document.getElementById('plannedEMI').value = loan.emi; document.getElementById('adhocPayment').value = 0; document.getElementById('detailedAnalysisSection').classList.remove('hidden'); document.getElementById('detailedAnalysisSection').scrollIntoView({ behavior: 'smooth' }); runFullLoanAnalysis(loan);}
        
        document.getElementById('loanForm').addEventListener('submit', (e) => { e.preventDefault(); loans.push({ name: e.target.loanName.value, principal: parseFloat(e.target.principalLeft.value), rate: parseFloat(e.target.interestRate.value), emi: parseFloat(e.target.currentEMI.value), tenure: parseInt(e.target.emisLeft.value) }); e.target.reset(); renderAllLists(); updateDashboard(); });
        document.getElementById('assetForm').addEventListener('submit', (e) => { e.preventDefault(); const typeSelect = e.target.querySelector('.asset-category-select'); let type = typeSelect.value; if (type === 'Other') { type = e.target.querySelector('.custom-asset-category-input').value || 'Other'; } assets.push({ name: e.target.assetName.value, type: type, value: parseFloat(e.target.assetValue.value), monthlySip: parseFloat(e.target.monthlySip.value) || 0, returnRate: parseFloat(e.target.assetReturn.value) }); e.target.reset(); e.target.querySelector('.custom-asset-category-input').classList.add('hidden'); renderAllLists(); updateDashboard(); });
        document.getElementById('goalForm').addEventListener('submit', (e) => { e.preventDefault(); goals.push({ name: e.target.goalName.value, amount: parseFloat(e.target.goalAmount.value), years: parseInt(e.target.goalYears.value) }); e.target.reset(); renderAllLists(); updateDashboard(); });
        document.getElementById('insuranceForm').addEventListener('submit', (e) => { e.preventDefault(); insurances.push({ type: e.target.insuranceType.value, cover: parseFloat(e.target.insuranceCover.value), premiumAmount: parseFloat(e.target.premiumAmount.value), premiumFrequency: e.target.premiumFrequency.value }); e.target.reset(); renderAllLists(); updateDashboard(); });
        document.getElementById('incomeForm').addEventListener('submit', e => { e.preventDefault(); const categorySelect = e.target.querySelector('.income-category-select'); let source = categorySelect.value; if (source === 'Other') { source = e.target.querySelector('.custom-income-category-input').value || 'Other'; } const amount = parseFloat(e.target.querySelector('.income-amount-input').value); incomes.push({ source, amount }); e.target.reset(); e.target.querySelector('.custom-income-category-input').classList.add('hidden'); renderAllLists(); updateDashboard(); });
        document.getElementById('wantsForm').addEventListener('submit', e => { e.preventDefault(); const categorySelect = e.target.querySelector('.wants-category-select'); let category = categorySelect.value; if (category === 'Other') { category = e.target.querySelector('.custom-wants-category-input').value || 'Other'; } const amount = parseFloat(e.target.querySelector('.wants-amount-input').value); wants.push({ category, amount }); e.target.reset(); e.target.querySelector('.custom-wants-category-input').classList.add('hidden'); renderAllLists(); updateDashboard(); });

        currentAgeInput.addEventListener('input', updateDashboard);
        document.getElementById('recalculateBtn').addEventListener('click', () => {if (activeAnalysisIndex !== -1) {runFullLoanAnalysis(loans[activeAnalysisIndex]);}});
        document.getElementById('refreshDashboardBtn').addEventListener('click', updateDashboard);

        // --- CALCULATOR EVENT LISTENERS ---
        document.getElementById('emiCalcForm').addEventListener('submit', e => { e.preventDefault(); const p = parseFloat(document.getElementById('emiLoanAmount').value); const r = parseFloat(document.getElementById('emiInterestRate').value) / 12 / 100; const n = parseFloat(document.getElementById('emiTenure').value) * 12; const emi = p * r * (Math.pow(1 + r, n)) / (Math.pow(1 + r, n) - 1); const resultEl = document.getElementById('emiResult'); resultEl.innerHTML = `<div class="label">Your Monthly EMI</div><div class="value">${formatCurrency(emi)}</div>`; resultEl.classList.remove('hidden'); });
        document.getElementById('haForm').addEventListener('submit', e => { e.preventDefault(); const income = parseFloat(document.getElementById('haMonthlyIncome').value); const existingEmi = parseFloat(document.getElementById('haExistingEmi').value); const tenure = parseFloat(document.getElementById('haTenure').value) * 12; const rate = parseFloat(document.getElementById('haInterestRate').value) / 12 / 100; const maxEmi = (income * 0.45) - existingEmi; if (maxEmi <= 0) { alert('Your existing EMIs are too high to afford a new home loan.'); return; } const loanAmount = (maxEmi / (rate * Math.pow(1 + rate, tenure))) * (Math.pow(1 + rate, tenure) - 1); const propertyValue = loanAmount / 0.8; const resultEl = document.getElementById('haResult'); resultEl.innerHTML = `<div class="calc-result mb-2"><div class="label">Affordable Home Loan</div><div class="value">${formatLargeCurrency(loanAmount)}</div></div><div class="calc-result"><div class="label">Estimated Property Value</div><div class="value">${formatLargeCurrency(propertyValue)}</div></div>`; resultEl.classList.remove('hidden'); });
        document.getElementById('sipForm').addEventListener('submit', e => { e.preventDefault(); const p = parseFloat(document.getElementById('sipAmount').value); const r = parseFloat(document.getElementById('sipReturnRate').value) / 100; const t = parseFloat(document.getElementById('sipDuration').value); const n = 12; const i = r / n; const N = n * t; const futureValue = p * ((Math.pow(1 + i, N) - 1) / i) * (1 + i); const totalInvested = p * N; const wealthGained = futureValue - totalInvested; const resultEl = document.getElementById('sipResult'); resultEl.innerHTML = `<div class="calc-result mb-2"><div class="label">Total Invested</div><div class="value">${formatLargeCurrency(totalInvested)}</div></div><div class="calc-result mb-2"><div class="label">Wealth Gained</div><div class="value">${formatLargeCurrency(wealthGained)}</div></div><div class="calc-result bg-indigo-200"><div class="label">Total Corpus</div><div class="value">${formatLargeCurrency(futureValue)}</div></div>`; resultEl.classList.remove('hidden'); });

        // --- AUTHENTICATION LOGIC ---
        function handleLogin() {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider).catch(error => {
                console.error("Authentication Error:", error);
                alert("Could not log in. Please try again.");
            });
        }

        function handleLogout() {
            auth.signOut();
        }

        function updateUIForUser(user) {
            const loginBtn = document.getElementById('loginBtn');
            const userInfo = document.getElementById('user-info');
            const userNameEl = document.getElementById('userName');
            const saveDataBtn = document.getElementById('saveDataBtn');
            const loadDataBtn = document.getElementById('loadDataBtn');
            const deleteDataBtn = document.getElementById('deleteDataBtn');
            
            if (user) {
                loginBtn.classList.add('hidden');
                userInfo.classList.remove('hidden');
                userNameEl.textContent = user.displayName;
                saveDataBtn.classList.remove('hidden');
                loadDataBtn.classList.remove('hidden');
                deleteDataBtn.classList.remove('hidden');
            } else {
                loginBtn.classList.remove('hidden');
                userInfo.classList.add('hidden');
                userNameEl.textContent = '';
                saveDataBtn.classList.add('hidden');
                loadDataBtn.classList.add('hidden');
                 deleteDataBtn.classList.add('hidden');
            }
        }
        
        async function saveData() {
            const user = auth.currentUser;
            if (!user) {
                alert("Please log in to save your data.");
                return;
            }
            const saveDataBtn = document.getElementById('saveDataBtn');
            saveDataBtn.textContent = "Saving...";
            saveDataBtn.disabled = true;

            const dataToSave = {
                currentAge: currentAgeInput.value,
                incomes, wants, assets, loans, goals, insurances,
                lastSaved: new Date().toISOString()
            };

            try {
                await db.collection("users").doc(user.uid).set(dataToSave);
                alert("Data saved successfully!");
            } catch (error) {
                console.error("Error saving data: ", error);
                alert("Could not save data. Please try again.");
            } finally {
                saveDataBtn.textContent = "Save Data";
                saveDataBtn.disabled = false;
            }
        }

        async function loadData() {
            const user = auth.currentUser;
            if (!user) {
                alert("Please log in to load your data.");
                return;
            }
             const loadDataBtn = document.getElementById('loadDataBtn');
            loadDataBtn.textContent = "Loading...";
            loadDataBtn.disabled = true;

            try {
                const docRef = db.collection("users").doc(user.uid);
                const doc = await docRef.get();
                if (doc.exists) {
                    const data = doc.data();
                    const lastSavedDate = new Date(data.lastSaved).toLocaleString();
                    if(confirm(`Saved data found from ${lastSavedDate}. Do you want to load it?`)) {
                        currentAgeInput.value = data.currentAge || '';
                        incomes = data.incomes || [];
                        wants = data.wants || [];
                        assets = data.assets || [];
                        loans = data.loans || [];
                        goals = data.goals || [];
                        insurances = data.insurances || [];
                        
                        renderAllLists();
                        updateDashboard();
                        alert("Data loaded successfully!");
                    }
                } else {
                    alert("No saved data found for your account.");
                }
            } catch (error) {
                console.error("Error loading data: ", error);
                alert("Could not load data. Please try again.");
            } finally {
                loadDataBtn.textContent = "Load Data";
                loadDataBtn.disabled = false;
            }
        }
        
        async function deleteUserData() {
            const user = auth.currentUser;
            if (!user) return;

            if (confirm("Are you sure you want to permanently delete all your saved financial data? This action cannot be undone.")) {
                try {
                    await db.collection("users").doc(user.uid).delete();
                    alert("Your saved data has been deleted.");
                    resetAllData();
                } catch (error) {
                    console.error("Error deleting data:", error);
                    alert("Could not delete your data. Please try again.");
                }
            }
        }


        function resetAllData() {
            loans = []; assets = []; goals = []; insurances = []; incomes = []; wants = [];
            currentAgeInput.value = '';
            renderAllLists();
            updateDashboard();
        }

        // --- INITIALIZATION ---
        window.onload = () => {
            showTab('dashboard');
            renderAllLists();
            updateDashboard();
            
            auth.onAuthStateChanged(user => {
                updateUIForUser(user);
                 if (user) { 
                    loadData();
                } else {
                    resetAllData();
                }
            });

            document.getElementById('loginBtn').addEventListener('click', handleLogin);
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);
            document.getElementById('saveDataBtn').addEventListener('click', saveData);
            document.getElementById('loadDataBtn').addEventListener('click', loadData);
            document.getElementById('deleteDataBtn').addEventListener('click', deleteUserData);

            document.getElementById('downloadPdfBtn').addEventListener('click', () => downloadPDF('downloadPdfBtn', 'Wealth'));
            document.getElementById('downloadInputsBtn').addEventListener('click', () => {
                const allData = [
                    ...incomes.map(i => ({ Type: 'Income', Details: i.source, Amount: i.amount })),
                    ...wants.map(w => ({ Type: 'Want', Details: w.category, Amount: w.amount })),
                    ...assets.map(a => ({ Type: 'Asset', Details: a.name, Asset_Type: a.type, Value: a.value, Monthly_SIP: a.monthlySip, Return_Rate_Percent: a.returnRate })),
                    ...loans.map(l => ({ Type: 'Loan', Details: l.name, Principal: l.principal, EMI: l.emi, Rate_Percent: l.rate })),
                    ...insurances.map(i => ({ Type: 'Insurance', Details: i.type, Cover: i.cover, Premium: i.premiumAmount, Frequency: i.premiumFrequency })),
                    ...goals.map(g => ({ Type: 'Goal', Details: g.name, Target_Amount: g.amount, Years_to_Achieve: g.years }))
                ];
                if (allData.length > 0) {
                    downloadCSV(allData, 'Financial_Inputs.csv');
                } else {
                    alert('No inputs to download.');
                }
            });
            document.getElementById('downloadLoanExcelBtn').addEventListener('click', () => {
                if (currentAmortizationSchedule.length > 0) {
                    const loanName = loans[activeAnalysisIndex].name.replace(/ /g, '_');
                    downloadCSV(currentAmortizationSchedule, `${loanName}_Amortization.csv`);
                } else {
                    alert('No amortization schedule to download. Please analyze a loan first.');
                }
            });
             document.getElementById('downloadLoanPdfBtn').addEventListener('click', () => downloadPDF('downloadLoanPdfBtn', 'Loan'));
            
            setupDynamicSelect(document.getElementById('incomeForm'), '.income-category-select', '.custom-income-category-input');
            setupDynamicSelect(document.getElementById('wantsForm'), '.wants-category-select', '.custom-wants-category-input');
            setupDynamicSelect(document.getElementById('assetForm'), '.asset-category-select', '.custom-asset-category-input');
            
            document.getElementById('recalculateBtn').addEventListener('click', () => {if (activeAnalysisIndex !== -1) {runFullLoanAnalysis(loans[activeAnalysisIndex]);}});
            document.getElementById('refreshDashboardBtn').addEventListener('click', updateDashboard);

            // Setup Sliders
            setupSlider('principalLeft', 'principalLeftSlider', 'principalLeftDisplay', (val) => formatLargeCurrency(val));
            setupSlider('interestRate', 'interestRateSlider', 'interestRateDisplay');
            setupSlider('currentEMI', 'currentEMISlider', 'currentEMIDisplay', (val) => formatCurrency(val));
            setupSlider('emisLeft', 'emisLeftSlider', 'emisLeftDisplay');
            
            setupSlider('emiLoanAmount', 'emiLoanAmountSlider', 'emiLoanAmountDisplay', (val) => formatLargeCurrency(val));
            setupSlider('emiInterestRate', 'emiInterestRateSlider', 'emiInterestRateDisplay');
            setupSlider('emiTenure', 'emiTenureSlider', 'emiTenureDisplay');

            setupSlider('haMonthlyIncome', 'haMonthlyIncomeSlider', 'haMonthlyIncomeDisplay', (val) => formatCurrency(val));
            setupSlider('haExistingEmi', 'haExistingEmiSlider', 'haExistingEmiDisplay', (val) => formatCurrency(val));
            setupSlider('haTenure', 'haTenureSlider', 'haTenureDisplay');
            setupSlider('haInterestRate', 'haInterestRateSlider', 'haInterestRateDisplay');
            
            setupSlider('sipAmount', 'sipAmountSlider', 'sipAmountDisplay', (val) => formatCurrency(val));
            setupSlider('sipReturnRate', 'sipReturnRateSlider', 'sipReturnRateDisplay');
            setupSlider('sipDuration', 'sipDurationSlider', 'sipDurationDisplay');
            
            // Modal and Helper Icon Logic
            const modal = document.getElementById('modal');
            const closeModalBtn = document.getElementById('closeModalBtn');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');

            function showModal(title, content) {
                modalTitle.textContent = title;
                modalBody.innerHTML = content;
                modal.classList.remove('hidden');
            }
            closeModalBtn.onclick = () => modal.classList.add('hidden');
            
            const helpContent = {
                score: 'This score (0-100) gives a snapshot of your financial health. It is based on your savings rate, debt levels, emergency fund, and insurance coverage.',
                budget: 'This chart shows your spending based on the 50-30-20 rule: 50% for Needs (EMIs, essentials), 30% for Wants (lifestyle), and 20% for Savings.',
                retirement: 'This estimates the total corpus you may need for retirement based on your current lifestyle expenses and calculates the required monthly investment (SIP) to reach it.',
                goals: 'Set your financial goals here, like a downpayment for a house or a car. The planner will calculate the monthly SIP needed to achieve each goal.',
                income: 'Add all your sources of monthly income here. This is the foundation for all calculations.',
                assets: 'Log all your assets, their current value, and any ongoing monthly investments (SIPs). This is used to calculate your net worth and project its growth.',
                expenses: 'Categorize your discretionary spending (Wants) to understand your lifestyle expenses. Add your insurance policies to factor their premiums into your budget as "Needs".',
                loans: 'Add and manage all your loans. You can analyze each one to see its full repayment schedule and the impact of prepayments.',
                emi: 'Calculate the Equated Monthly Instalment (EMI) for any loan by providing the loan amount, interest rate, and tenure.',
                affordability: 'Estimate the maximum home loan you can afford based on your income, existing financial commitments, and desired loan terms.',
                simulator: 'A "what-if" tool to see how a specific monthly investment (SIP) could grow over time at an expected rate of return.'
            };
            
            document.querySelectorAll('.helper-icon').forEach(icon => {
                icon.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const helpKey = e.target.dataset.help;
                    showModal('Help', helpContent[helpKey]);
                });
            });

            document.getElementById('privacyPolicyLink').addEventListener('click', (e) => {
                e.preventDefault();
                const privacyContent = `
                    <p class="mb-2"><strong>1. Data Storage:</strong> When you log in with your Google Account, your financial data is saved securely in your own private document within our Firestore database. Only you, the authenticated user, can access this data.</p>
                    <p class="mb-2"><strong>2. Data Usage:</strong> Your data is only used to power the features within this application and is never shared with third parties.</p>
                    <p class="mb-2"><strong>3. User Control:</strong> You have full control over your data. You can use the "Delete Data" button in your user profile area to permanently erase all your saved information from our database at any time.</p>
                    <p>If you do not log in, all data remains in your browser for the current session and is not saved anywhere.</p>
                `;
                showModal('Privacy Policy', privacyContent);
            });
        };
    </script>
</body>
</html>
